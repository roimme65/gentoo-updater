name: Pull Request Check
run-name: âœ… PR Check - #${{ github.event.pull_request.number }}

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|refactor|test|chore|perf):"; then
            echo "âœ“ PR title follows conventional commits"
          else
            echo "âš  PR title should follow format: type: description"
            echo "  Types: feat, fix, docs, refactor, test, chore, perf"
          fi

      - name: Check for breaking changes
        run: |
          if git log --oneline origin/main..HEAD | grep -qi "BREAKING"; then
            echo "âš  Breaking changes detected"
            echo "Make sure to update CHANGELOG.md and bump major version"
          else
            echo "âœ“ No breaking changes"
          fi

      - name: Verify CHANGELOG update
        run: |
          if git diff --name-only origin/main..HEAD | grep -q "CHANGELOG.md"; then
            echo "âœ“ CHANGELOG.md updated"
          else
            echo "âš  Consider updating CHANGELOG.md"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run all checks
        run: |
          python -m py_compile gentoo-updater.py
          python3 -m json.tool gentoo-updater.conf.example > /dev/null
          echo "âœ“ All checks passed"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Automated checks passed!\n\n' +
                    '- Python syntax: âœ“\n' +
                    '- Config validation: âœ“\n' +
                    '- File structure: âœ“\n\n' +
                    'Ready for review! ðŸš€'
            })
