## üöÄ Release v1.1.0 - Automatische Kernel-Modul-Neucompilierung

### ‚ö° Highlights

Das gro√üe **Kernel-Module Update**! Nie wieder manuell `emerge @module-rebuild` nach einem Kernel-Update!

---

### ‚ú® Neue Hauptfeatures

#### üîß Automatische Kernel-Modul-Neucompilierung
- **Automatische Erkennung** von Kernel-Updates w√§hrend des System-Updates
- **Intelligenter Rebuild** aller externen Kernel-Module:
  - NVIDIA-Treiber (`nvidia-drivers`)
  - VirtualBox-Module (`virtualbox-modules`)
  - ZFS-Module
  - Alle weiteren externen Module in `@module-rebuild`
- **Nachtr√§gliche Pr√ºfung** auf veraltete Module (auch ohne Update)
- **Kernel-Version-Vergleich** (laufender vs. installierter Kernel)

#### üõ°Ô∏è Robuste Fehlerbehandlung
- **Automatisches Manifest-Cleanup** behebt h√§ufigen "Manifest verification failed" Fehler
- **Retry-Mechanismus** bei Repository-Sync-Fehlern
- Automatisches L√∂schen des Quarantine-Verzeichnisses
- Bis zu 2 Sync-Versuche mit automatischem Cleanup dazwischen

#### üéØ Neue Command-Line Option
- **`--rebuild-modules`**: Erzwingt Neucompilierung der Kernel-Module
- N√ºtzlich nach **manuellem Kernel-Update**
- Schneller als komplettes System-Update
- Separate Funktion nur f√ºr Modul-Rebuild

---

### üìã Was bedeutet das f√ºr dich?

#### ‚úÖ Vorher (v1.0.0):
```bash
sudo gentoo-updater
# ... System-Update l√§uft ...
# Kernel wurde aktualisiert!

# ü§î Manuell nacharbeiten:
sudo emerge @module-rebuild  # NVIDIA, VirtualBox, etc.
sudo reboot
```

#### üéâ Jetzt (v1.1.0):
```bash
sudo gentoo-updater
# ... System-Update l√§uft ...
# Kernel wurde aktualisiert!
# ‚ú® Module werden AUTOMATISCH neu gebaut!
sudo reboot
```

#### üÜï Neuer Use-Case:
```bash
# Nach manuellem Kernel-Update:
cd /usr/src/linux
make && make modules_install && make install
grub-mkconfig -o /boot/grub/grub.cfg

# Nur Module neu bauen (schnell!):
sudo gentoo-updater --rebuild-modules
sudo reboot
```

---

### üîÑ Detaillierte √Ñnderungen

#### Neue Funktionen
1. **`cleanup_manifest_quarantine()`**
   - R√§umt `/var/db/repos/gentoo/.tmp-unverified-download-quarantine` auf
   - Wird automatisch vor Sync ausgef√ºhrt
   - Behebt Manifest-Fehler proaktiv

2. **`check_kernel_module_mismatch()`**
   - Pr√ºft `emerge --pretend @module-rebuild` auf veraltete Module
   - Vergleicht `uname -r` mit `eselect kernel show`
   - Erkennt Kernel-Updates die bereits installiert sind

3. **`rebuild_kernel_modules(force=False)`**
   - Baut alle Module in `@module-rebuild` neu
   - Zeigt Liste der zu bauenden Module
   - Gibt Hinweis f√ºr Neustart nach erfolgreichem Rebuild

4. **`run_modules_only()`**
   - Standalone-Funktion f√ºr `--rebuild-modules`
   - √úberspringt System-Update
   - Fokussiert nur auf Modul-Neucompilierung

#### Ge√§nderte Funktionen
- **`sync_repositories(retry=1)`**
  - Unterst√ºtzt jetzt Retry-Parameter
  - Automatischer Retry bei Fehler mit Cleanup
  - Bis zu 2 Versuche mit 2 Sekunden Wartezeit

- **`update_system() -> tuple[bool, bool]`**
  - Gibt jetzt Tuple zur√ºck: `(success, kernel_updated)`
  - Analysiert `--pretend` Output auf `sys-kernel/*-sources`
  - Gibt Warnung bei erkanntem Kernel-Update

#### Erweiterte Imports
```python
import shutil  # F√ºr Verzeichnis-Operationen
import time    # F√ºr Retry-Delays
```

---

### üì¶ Installation / Upgrade

#### Von v1.0.0 upgraden:
```bash
cd /pfad/zu/gentoo-updater
git pull
sudo cp gentoo-updater.py /usr/local/bin/gentoo-updater
sudo chmod +x /usr/local/bin/gentoo-updater
```

#### Neu installieren:
```bash
git clone https://github.com/roimme65/gentoo-updater.git
cd gentoo-updater
sudo ./install.sh
```

#### Version pr√ºfen:
```bash
gentoo-updater --version
# Sollte anzeigen: Gentoo Updater v1.1.0
```

---

### üöÄ Verwendung

#### Standard Update (mit automatischem Modul-Rebuild):
```bash
sudo gentoo-updater
```

**Ablauf:**
```
1. Repository-Synchronisation (mit Retry)
2. eix-Datenbank aktualisieren
3. Updates pr√ºfen
4. System-Update (erkennt Kernel-Updates)
5. Kernel-Module neu kompilieren ‚ú® NEU!
6. Cleanup (depclean)
7. Dependency-Reparatur
8. Kernel-Pr√ºfung
9. Konfigurations-Pr√ºfung
```

#### Nur Module neu bauen:
```bash
sudo gentoo-updater --rebuild-modules
```

**Output:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       KERNEL-MODULE NEU KOMPILIEREN                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[INFO] Pr√ºfe Kernel-Module Status...
[WARNING] Veraltete oder fehlende Kernel-Module erkannt!
[INFO] Folgende Module werden neu gebaut:

 * x11-drivers/nvidia-drivers-550.54.14
 * app-emulation/virtualbox-modules-7.0.14

[INFO] Kompiliere Kernel-Module neu...
>>> Emerging (1 of 2) x11-drivers/nvidia-drivers-550.54.14
>>> Emerging (2 of 2) app-emulation/virtualbox-modules-7.0.14
[SUCCESS] Alle Kernel-Module erfolgreich neu gebaut
[INFO] Tipp: Nach einem Neustart werden die neuen Module verwendet
```

#### Dry-Run zum Testen:
```bash
sudo gentoo-updater --dry-run
```

---

### üìä Beispiel-Szenarien

#### Szenario 1: Normales Update MIT Kernel
```bash
$ sudo gentoo-updater

SCHRITT 4: System-Update
[INFO] Analysiere zu aktualisierende Pakete...
[WARNING] Kernel-Update erkannt! Module werden nach dem Update neu gebaut.
[INFO] Aktualisiere System-Pakete...
>>> Installing sys-kernel/gentoo-sources-6.6.13
[SUCCESS] Aktualisiere System-Pakete erfolgreich abgeschlossen

SCHRITT 5: Kernel-Module neu kompilieren
[INFO] Pr√ºfe Kernel-Module Status...
[WARNING] Veraltete oder fehlende Kernel-Module erkannt!
[INFO] Folgende Module werden neu gebaut:
  - nvidia-drivers
  - virtualbox-modules
[SUCCESS] Alle Kernel-Module erfolgreich neu gebaut
[INFO] Tipp: Nach einem Neustart werden die neuen Module verwendet
```

#### Szenario 2: Update OHNE Kernel
```bash
$ sudo gentoo-updater

SCHRITT 4: System-Update
[INFO] Analysiere zu aktualisierende Pakete...
[SUCCESS] Aktualisiere System-Pakete erfolgreich abgeschlossen

SCHRITT 5: Kernel-Module neu kompilieren
[INFO] Pr√ºfe Kernel-Module Status...
[SUCCESS] Kernel-Module sind aktuell - keine Neucompilierung n√∂tig
```

#### Szenario 3: Manuelles Kernel-Update + Modul-Rebuild
```bash
# 1. Kernel manuell bauen
$ eselect kernel set 2
$ cd /usr/src/linux
$ make oldconfig && make && make modules_install && make install
$ grub-mkconfig -o /boot/grub/grub.cfg

# 2. Module schnell neu bauen
$ sudo gentoo-updater --rebuild-modules

KERNEL-MODULE NEU KOMPILIEREN
[INFO] Pr√ºfe Kernel-Module Status...
[WARNING] Laufender Kernel (6.6.9-gentoo) != Installierter Kernel (6.6.13-gentoo)
[INFO] Module sollten f√ºr den neuen Kernel gebaut werden
[SUCCESS] Alle Kernel-Module erfolgreich neu gebaut

# 3. Reboot
$ sudo reboot
```

#### Szenario 4: Manifest-Fehler (wird automatisch behoben)
```bash
$ sudo gentoo-updater

SCHRITT 1: Repository-Synchronisation (Versuch 1/2)
[INFO] R√§ume auf: /var/db/repos/gentoo/.tmp-unverified-download-quarantine
[SUCCESS] Quarantine-Verzeichnis gel√∂scht
[INFO] Synchronisiere Portage-Repositories...
!!! Manifest verification failed:
Manifest mismatch for dev-ruby/Manifest.gz
[ERROR] Synchronisiere Portage-Repositories fehlgeschlagen (Exit Code: 1)
[WARNING] Sync fehlgeschlagen - r√§ume auf und versuche erneut...

SCHRITT 1: Repository-Synchronisation (Versuch 2/2)
[INFO] Synchronisiere Portage-Repositories...
[SUCCESS] Synchronisiere Portage-Repositories erfolgreich abgeschlossen
```

---

### üêõ Behobene Bugs

- **Manifest verification failed**: Automatisches Cleanup + Retry behebt das Problem
- **Fehlende Module nach Kernel-Update**: Werden jetzt automatisch erkannt und gebaut
- **Sync-Fehler brechen Update ab**: Retry-Mechanismus macht Updates zuverl√§ssiger

---

### üîß Technische Details

#### Neue Type Hints
```python
def update_system(self) -> tuple[bool, bool]:
    """Returns: (success, kernel_updated)"""
    
def check_kernel_module_mismatch(self) -> bool:
    """Returns: True wenn Module neu gebaut werden m√ºssen"""
```

#### Intelligente Kernel-Erkennung
```python
# Pr√ºft emerge --pretend Output:
kernel_updated = "sys-kernel/" in result.stdout and "-sources" in result.stdout

# Pr√ºft Kernel-Version-Mismatch:
running_kernel = subprocess.run(["uname", "-r"], ...).stdout.strip()
selected_kernel = subprocess.run(["eselect", "kernel", "show"], ...)
```

#### Robuster Retry-Mechanismus
```python
def sync_repositories(self, retry: int = 1):
    if not success and retry < 2:
        self.cleanup_manifest_quarantine()
        time.sleep(2)
        return self.sync_repositories(retry=2)
```

---

### üìö Dokumentation

- **README.md**: Vollst√§ndig aktualisiert mit neuen Features
- **CHANGELOG.md**: Detaillierte Versionshistorie
- Neue Beispiele f√ºr `--rebuild-modules`
- Erweiterte Fehlerbehebung
- H√§ufige Anwendungsf√§lle dokumentiert

---

### ‚öôÔ∏è Kompatibilit√§t

- **Python**: 3.6+ (unver√§ndert)
- **Gentoo**: Alle aktuellen Versionen
- **Abw√§rtskompatibel**: Alte Nutzung funktioniert weiterhin
- **Neue Optionen**: Sind optional

---

### üéØ Migration von v1.0.0

Keine Breaking Changes! Alle alten Kommandos funktionieren weiterhin:

```bash
# Alles funktioniert wie vorher:
sudo gentoo-updater
sudo gentoo-updater --dry-run
sudo gentoo-updater --verbose

# NEU hinzugekommen:
sudo gentoo-updater --rebuild-modules
```

---

### ü§ù Beitragen

Danke an alle, die Feedback und Bug-Reports eingereicht haben!

Weitere Contributions sind willkommen:
- **Issues**: https://github.com/roimme65/gentoo-updater/issues
- **Pull Requests**: https://github.com/roimme65/gentoo-updater/pulls

---

### üîó Links

- **Repository**: https://github.com/roimme65/gentoo-updater
- **v1.1.0 Release**: https://github.com/roimme65/gentoo-updater/releases/tag/v1.1.0
- **Changelog**: https://github.com/roimme65/gentoo-updater/blob/main/CHANGELOG.md
- **Dokumentation**: https://github.com/roimme65/gentoo-updater/blob/main/README.md

---

### üìù Credits

Entwickelt f√ºr Gentoo Linux Nutzer, die automatische Kernel-Modul-Verwaltung wollten! üéä

**Besonderer Dank an:**
- NVIDIA-Nutzer f√ºr das Feedback zu fehlenden Modulen
- VirtualBox-User f√ºr die Use-Case-Beschreibung
- Community f√ºr Bug-Reports zu Manifest-Fehlern

---

### üéâ Fazit

Version 1.1.0 macht Gentoo-Updates noch komfortabler:
- ‚úÖ Keine vergessenen Kernel-Module mehr
- ‚úÖ Weniger manuelle Nacharbeit
- ‚úÖ Zuverl√§ssigere Updates durch Retry
- ‚úÖ Flexiblere Nutzung durch neue Optionen

Viel Spa√ü mit dem Update! üöÄ
